<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Page Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #818cf8;
      --primary-dark: #6366f1;
      --primary-glow: rgba(129, 140, 248, 0.25);
      --accent: #f472b6;
      --accent-glow: rgba(244, 114, 182, 0.2);
      --bg: #0c0f1a;
      --bg-secondary: #141827;
      --bg-tertiary: #1e2336;
      --bg-elevated: #252a3d;
      --text: #f1f5f9;
      --text-secondary: #8b95a8;
      --text-muted: #5a6478;
      --border: rgba(255, 255, 255, 0.08);
      --border-subtle: rgba(255, 255, 255, 0.04);
      --success: #34d399;
      --success-bg: rgba(52, 211, 153, 0.12);
      --warning: #fbbf24;
      --warning-bg: rgba(251, 191, 36, 0.12);
      --error: #f87171;
      --error-bg: rgba(248, 113, 113, 0.12);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 40px var(--primary-glow);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Subtle background texture */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(ellipse 80% 50% at 50% -20%, var(--primary-glow), transparent),
        radial-gradient(ellipse 60% 40% at 100% 100%, var(--accent-glow), transparent);
      pointer-events: none;
      z-index: 0;
    }

    .app {
      display: grid;
      grid-template-columns: 300px 1fr 360px;
      grid-template-rows: 60px 1fr;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg) 100%);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 24px;
      gap: 20px;
      backdrop-filter: blur(12px);
    }
    .logo {
      font-family: 'Outfit', sans-serif;
      font-size: 17px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: -0.02em;
    }
    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: var(--shadow-sm), 0 0 20px var(--primary-glow);
    }
    .path-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-normal);
    }
    .path-display:hover {
      background: var(--bg-elevated);
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-glow);
    }
    .path-label {
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .path-value {
      color: var(--text);
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-weight: 500;
    }
    .path-chevron {
      color: var(--text-muted);
      font-size: 10px;
      transition: transform var(--transition-fast);
    }
    .path-display:hover .path-chevron { transform: translateY(2px); }
    .header-actions { margin-left: auto; display: flex; gap: 10px; }

    /* Buttons */
    .btn {
      padding: 9px 18px;
      border-radius: var(--radius-md);
      border: none;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      transition: all var(--transition-normal);
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 100%);
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    .btn:hover::before { opacity: 1; }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: var(--shadow-sm), 0 0 20px var(--primary-glow);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md), 0 0 30px var(--primary-glow);
    }
    .btn-primary:active { transform: translateY(0); }
    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: var(--bg-elevated);
      border-color: rgba(255,255,255,0.15);
    }
    .btn-sm { padding: 6px 12px; font-size: 12px; }
    .btn-icon {
      padding: 8px 10px;
      min-width: 36px;
      justify-content: center;
    }

    /* Sidebar */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .sidebar-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    }
    .sidebar-title {
      font-family: 'Outfit', sans-serif;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .sidebar-content::-webkit-scrollbar { width: 6px; }
    .sidebar-content::-webkit-scrollbar-track { background: transparent; }
    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }
    .sidebar-content::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* HTML File Groups */
    .file-group {
      margin-bottom: 12px;
      background: var(--bg);
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--border);
      transition: all var(--transition-normal);
    }
    .file-group:hover {
      border-color: rgba(255,255,255,0.12);
    }
    .file-group-header {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      gap: 10px;
      border-left: 3px solid var(--primary);
      transition: all var(--transition-normal);
    }
    .file-group-header:hover { background: var(--bg-tertiary); }
    .group-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
      box-shadow: 0 0 8px currentColor;
    }
    .group-name {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    .group-count {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      font-weight: 500;
    }
    .group-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    .file-group-header:hover .group-actions { opacity: 1; }
    .group-files {
      border-top: 1px solid var(--border);
    }

    /* File Items */
    .file-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      cursor: pointer;
      gap: 12px;
      transition: all var(--transition-normal);
      border-left: 3px solid transparent;
      position: relative;
    }
    .file-item::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent 0%, var(--primary-glow) 100%);
      opacity: 0;
      transition: opacity var(--transition-normal);
      pointer-events: none;
    }
    .file-item:hover { background: var(--bg-tertiary); }
    .file-item.active {
      background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%);
      border-left-color: white;
    }
    .file-item.active::after { opacity: 0.2; }
    .file-item.selected {
      border-left-color: var(--warning);
      background: var(--warning-bg);
    }
    .file-icon {
      font-size: 18px;
      opacity: 0.8;
    }
    .file-info { flex: 1; min-width: 0; }
    .file-name {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 2px;
    }
    .file-path {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-item.active .file-path { color: rgba(255,255,255,0.6); }
    .file-state-tag {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      font-weight: 500;
    }
    .file-item.active .file-state-tag {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    /* Ungrouped Files */
    .ungrouped-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }
    .ungrouped-title {
      font-size: 10px;
      color: var(--text-muted);
      padding: 6px 14px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    /* Preview Container */
    .preview-container {
      display: flex;
      flex-direction: column;
      background: radial-gradient(ellipse at center, var(--bg-tertiary) 0%, var(--bg) 100%);
      position: relative;
      overflow: hidden;
    }
    .preview-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(90deg, var(--border-subtle) 0px, var(--border-subtle) 1px, transparent 1px, transparent 40px),
        repeating-linear-gradient(0deg, var(--border-subtle) 0px, var(--border-subtle) 1px, transparent 1px, transparent 40px);
      pointer-events: none;
    }
    .preview-toolbar {
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      border-bottom: 1px solid var(--border);
      position: relative;
      z-index: 10;
    }
    .device-selector { display: flex; gap: 6px; }
    .device-btn {
      padding: 7px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text-muted);
      font-family: 'DM Sans', sans-serif;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-normal);
    }
    .device-btn:hover {
      color: var(--text-secondary);
      border-color: rgba(255,255,255,0.15);
    }
    .device-btn.active {
      border-color: var(--primary);
      color: var(--primary);
      background: rgba(129, 140, 248, 0.1);
      box-shadow: 0 0 12px var(--primary-glow);
    }
    .preview-actions {
      margin-left: auto;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .picker-btn {
      padding: 8px 14px;
      background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
      color: #000;
      border: none;
      border-radius: var(--radius-md);
      font-family: 'DM Sans', sans-serif;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all var(--transition-normal);
      box-shadow: var(--shadow-sm), 0 0 16px var(--warning-bg);
    }
    .picker-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md), 0 0 24px rgba(251, 191, 36, 0.3);
    }
    .picker-btn.active {
      background: linear-gradient(135deg, var(--error) 0%, #dc2626 100%);
      color: white;
      box-shadow: var(--shadow-sm), 0 0 16px var(--error-bg);
    }
    .preview-info {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }

    .preview-frame-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
      overflow: auto;
      position: relative;
      z-index: 5;
    }
    .phone-frame {
      background: linear-gradient(145deg, #2a2a2a 0%, #1a1a1a 100%);
      border-radius: 48px;
      padding: 14px;
      box-shadow:
        var(--shadow-lg),
        inset 0 1px 0 rgba(255,255,255,0.1),
        0 0 60px rgba(0,0,0,0.5);
      position: relative;
    }
    .phone-frame::before {
      content: '';
      position: absolute;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 24px;
      background: #0a0a0a;
      border-radius: 12px;
      z-index: 10;
    }
    .phone-screen {
      width: 375px;
      height: 812px;
      border-radius: 38px;
      overflow: hidden;
      background: white;
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.3);
    }
    .phone-screen iframe { width: 100%; height: 100%; border: none; }
    .empty-preview {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      text-align: center;
      background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
    }
    .empty-preview-icon {
      font-size: 56px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    .empty-preview p {
      font-size: 14px;
      color: #64748b;
    }

    /* Element picker overlay */
    .picker-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 100;
    }
    .picker-overlay.active { pointer-events: auto; cursor: crosshair; }
    .element-highlight {
      position: absolute;
      border: 2px solid var(--primary);
      background: var(--primary-glow);
      pointer-events: none;
      transition: all 0.1s;
      border-radius: 4px;
    }
    .element-tooltip {
      position: absolute;
      background: var(--bg-secondary);
      color: var(--text);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      white-space: nowrap;
      z-index: 101;
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border);
    }

    /* Right Panel */
    .panel {
      background: var(--bg-secondary);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    }
    .panel-tab {
      flex: 1;
      padding: 14px 12px;
      text-align: center;
      font-family: 'Outfit', sans-serif;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all var(--transition-normal);
      position: relative;
    }
    .panel-tab::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 50%;
      width: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      transition: all var(--transition-normal);
      transform: translateX(-50%);
    }
    .panel-tab:hover {
      color: var(--text-secondary);
      background: rgba(255,255,255,0.02);
    }
    .panel-tab.active {
      color: var(--text);
    }
    .panel-tab.active::after {
      width: 100%;
    }
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .panel-content::-webkit-scrollbar { width: 6px; }
    .panel-content::-webkit-scrollbar-track { background: transparent; }
    .panel-content::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }
    .panel-section {
      margin-bottom: 24px;
    }
    .panel-section-title {
      font-family: 'Outfit', sans-serif;
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* Forms */
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 11px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      transition: all var(--transition-normal);
    }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-glow);
    }
    .form-input::placeholder, .form-textarea::placeholder {
      color: var(--text-muted);
    }
    .form-textarea {
      resize: vertical;
      min-height: 72px;
      line-height: 1.5;
    }
    .form-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238b95a8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    /* Interactions List */
    .interaction-item {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      transition: all var(--transition-normal);
    }
    .interaction-item:hover {
      border-color: rgba(255,255,255,0.12);
    }
    .interaction-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }
    .interaction-selector {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--primary);
      background: rgba(129, 140, 248, 0.1);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .interaction-type {
      font-size: 10px;
      padding: 4px 10px;
      background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
      color: #000;
      border-radius: var(--radius-sm);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .delete-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 6px;
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }
    .delete-btn:hover {
      color: var(--error);
      background: var(--error-bg);
    }

    /* Colors */
    .color-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .color-chip {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      border: 2px solid transparent;
      cursor: pointer;
      position: relative;
      transition: all var(--transition-fast);
    }
    .color-chip:hover {
      transform: scale(1.1);
      border-color: rgba(255,255,255,0.3);
    }
    .color-chip:hover::after {
      content: attr(data-color);
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      white-space: nowrap;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      z-index: 10;
    }

    /* Tags */
    .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag {
      padding: 6px 12px;
      background: var(--bg);
      border-radius: var(--radius-md);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all var(--transition-normal);
    }
    .tag.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      border-color: transparent;
      color: white;
    }
    .tag.clickable:hover {
      background: var(--bg-tertiary);
      border-color: rgba(255,255,255,0.12);
    }

    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-overlay.active {
      display: flex;
      animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal {
      background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg) 100%);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 560px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg), 0 0 80px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    .modal.wide { max-width: 720px; }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(180deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
    }
    .modal-title {
      font-family: 'Outfit', sans-serif;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    .modal-close {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all var(--transition-normal);
    }
    .modal-close:hover {
      background: var(--bg-tertiary);
      color: var(--text);
      border-color: rgba(255,255,255,0.15);
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 18px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: var(--bg-secondary);
    }

    /* File Browser */
    .browser-path {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: var(--bg);
      border-radius: var(--radius-md);
      margin-bottom: 14px;
      border: 1px solid var(--border);
    }
    .browser-path-input {
      flex: 1;
      background: none;
      border: none;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
    }
    .browser-path-input:focus { outline: none; }
    .browser-list {
      max-height: 280px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--bg);
    }
    .browser-list::-webkit-scrollbar { width: 6px; }
    .browser-list::-webkit-scrollbar-track { background: transparent; }
    .browser-list::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }
    .browser-item {
      display: flex;
      align-items: center;
      padding: 12px 14px;
      gap: 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all var(--transition-fast);
    }
    .browser-item:last-child { border-bottom: none; }
    .browser-item:hover { background: var(--bg-tertiary); }
    .browser-item.selected {
      background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary) 100%);
    }
    .browser-icon { font-size: 20px; }
    .browser-name {
      font-size: 13px;
      font-weight: 500;
    }

    /* Group Color Picker */
    .color-picker-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .color-option {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-md);
      cursor: pointer;
      border: 2px solid transparent;
      transition: all var(--transition-normal);
      position: relative;
    }
    .color-option:hover {
      transform: scale(1.1);
    }
    .color-option.selected {
      border-color: white;
      box-shadow: 0 0 0 2px var(--bg), 0 0 16px currentColor;
    }
    .color-option.selected::after {
      content: 'âœ“';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      font-weight: 700;
      text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    }

    /* Prompt Preview */
    .prompt-preview {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 18px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      line-height: 1.7;
      white-space: pre-wrap;
      max-height: 360px;
      overflow-y: auto;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    .prompt-preview::-webkit-scrollbar { width: 6px; }
    .prompt-preview::-webkit-scrollbar-track { background: transparent; }
    .prompt-preview::-webkit-scrollbar-thumb {
      background: var(--bg-elevated);
      border-radius: 3px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: linear-gradient(135deg, var(--success) 0%, #10b981 100%);
      color: white;
      padding: 14px 24px;
      border-radius: var(--radius-lg);
      font-size: 13px;
      font-weight: 600;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1001;
      box-shadow: var(--shadow-md), 0 0 24px var(--success-bg);
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* Selection Toolbar */
    .selection-toolbar {
      background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
      color: #000;
      padding: 10px 18px;
      display: none;
      align-items: center;
      gap: 14px;
      font-size: 13px;
      font-weight: 500;
    }
    .selection-toolbar.active { display: flex; }
    .selection-count {
      font-weight: 700;
      font-size: 15px;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">ğŸ“±</div>
        <span>App Page Studio</span>
      </div>

      <div class="path-display" onclick="showProjectSelector()">
        <span class="path-label">é¡¹ç›®</span>
        <span class="path-value" id="projectPathDisplay">æœªé€‰æ‹©</span>
        <span class="path-chevron">â–¼</span>
      </div>

      <div class="header-actions">
        <button class="btn btn-secondary" onclick="scanHtmlFiles()">
          <span>ğŸ”„</span> åˆ·æ–°
        </button>
        <button class="btn btn-secondary" onclick="saveConfig()">
          <span>ğŸ’¾</span> ä¿å­˜
        </button>
        <button class="btn btn-primary" onclick="showPromptModal()">
          <span>âœ¨</span> ç”Ÿæˆæç¤ºè¯
        </button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">HTML æ–‡ä»¶</span>
        <button class="btn btn-sm btn-secondary" onclick="createGroup()">
          <span>+</span> æ–°å»ºåˆ†ç»„
        </button>
      </div>

      <!-- Selection toolbar -->
      <div class="selection-toolbar" id="selectionToolbar">
        <span>å·²é€‰æ‹© <span class="selection-count" id="selectionCount">0</span> ä¸ªæ–‡ä»¶</span>
        <button class="btn btn-sm" style="background:#000;color:#fff" onclick="groupSelected()">åˆ›å»ºåˆ†ç»„</button>
        <button class="btn btn-sm btn-secondary" onclick="cancelSelection()">å–æ¶ˆ</button>
      </div>

      <div class="sidebar-content" id="fileList">
        <!-- Dynamic content -->
      </div>
    </aside>

    <!-- Preview -->
    <main class="preview-container">
      <div class="preview-toolbar">
        <div class="device-selector">
          <button class="device-btn active" data-width="375" data-height="812">iPhone 14</button>
          <button class="device-btn" data-width="390" data-height="844">iPhone Pro</button>
          <button class="device-btn" data-width="360" data-height="780">Android</button>
        </div>
        <div class="preview-actions">
          <button class="picker-btn" id="pickerBtn" onclick="togglePicker()">
            <span>ğŸ¯</span> é€‰æ‹©å…ƒç´ 
          </button>
          <span class="preview-info" id="previewInfo">æœªé€‰æ‹©æ–‡ä»¶</span>
        </div>
      </div>
      <div class="preview-frame-wrapper">
        <div class="phone-frame">
          <div class="phone-screen" id="phoneScreen">
            <div class="empty-preview">
              <div class="empty-preview-icon">ğŸ“„</div>
              <p>é€‰æ‹© HTML æ–‡ä»¶é¢„è§ˆ</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Panel -->
    <aside class="panel">
      <div class="panel-tabs">
        <div class="panel-tab active" data-panel="file">æ–‡ä»¶é…ç½®</div>
        <div class="panel-tab" data-panel="analysis">æ™ºèƒ½åˆ†æ</div>
      </div>

      <!-- File Config Panel -->
      <div class="panel-content" id="filePanel">
        <div class="panel-section">
          <div class="panel-section-title">åŸºæœ¬ä¿¡æ¯</div>
          <div class="form-group">
            <label class="form-label">çŠ¶æ€åç§°</label>
            <input type="text" class="form-input" id="fileStateName" placeholder="å¦‚ï¼šé»˜è®¤çŠ¶æ€ã€åŠ è½½ä¸­ã€ç©ºæ•°æ®">
          </div>
          <div class="form-group">
            <label class="form-label">çŠ¶æ€æè¿°</label>
            <textarea class="form-textarea" id="fileDescription" placeholder="æè¿°æ­¤çŠ¶æ€çš„æ˜¾ç¤ºåœºæ™¯"></textarea>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">æ‰€å±åˆ†ç»„</div>
          <select class="form-select" id="fileGroup">
            <option value="">æœªåˆ†ç»„</option>
          </select>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">äº¤äº’è¡Œä¸º</div>
          <div id="interactionList"></div>
          <button class="btn btn-secondary btn-sm" style="width:100%;margin-top:8px;" onclick="addInteraction()">
            <span>+</span> æ·»åŠ äº¤äº’
          </button>
        </div>
      </div>

      <!-- Analysis Panel -->
      <div class="panel-content" id="analysisPanel" style="display:none;">
        <div class="panel-section">
          <div class="panel-section-title">é¡µé¢ç»“æ„</div>
          <div class="tag-list" id="structureTags"></div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">æå–çš„é¢œè‰²</div>
          <div class="color-grid" id="colorGrid"></div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">å¯äº¤äº’å…ƒç´ </div>
          <div id="interactiveElements"></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Project Selector Modal -->
  <div class="modal-overlay" id="projectModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">é€‰æ‹©é¡¹ç›®</span>
        <button class="modal-close" onclick="closeProjectModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">æœ€è¿‘é¡¹ç›®</label>
          <div id="recentProjects" class="browser-list" style="max-height:200px;margin-bottom:16px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">æ·»åŠ æ–°é¡¹ç›®</label>
          <div class="browser-path">
            <span>ğŸ“</span>
            <input type="text" class="browser-path-input" id="newProjectPath" placeholder="è¾“å…¥é¡¹ç›®è·¯å¾„æˆ–æµè§ˆé€‰æ‹©">
            <button class="btn btn-sm btn-secondary" onclick="browseForProject()">æµè§ˆ</button>
          </div>
        </div>
        <div id="projectBrowser" style="display:none;">
          <div class="browser-path" style="margin-top:8px;">
            <button class="btn btn-sm btn-secondary" onclick="browseProjectPath('..')">â¬†ï¸</button>
            <input type="text" class="browser-path-input" id="projectBrowserPath" onkeypress="if(event.key==='Enter')browseProjectPath(this.value)">
          </div>
          <div class="browser-list" id="projectBrowserList" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProjectModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="addAndSwitchProject()">æ·»åŠ å¹¶åˆ‡æ¢</button>
      </div>
    </div>
  </div>

  <!-- Create Group Modal -->
  <div class="modal-overlay" id="groupModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">åˆ›å»ºé¡µé¢åˆ†ç»„</span>
        <button class="modal-close" onclick="closeGroupModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">åˆ†ç»„åç§°</label>
          <input type="text" class="form-input" id="groupName" placeholder="å¦‚ï¼šé¦–é¡µã€ç™»å½•é¡µ">
        </div>
        <div class="form-group">
          <label class="form-label">é¡µé¢æè¿°</label>
          <textarea class="form-textarea" id="groupDescription" placeholder="æè¿°æ­¤é¡µé¢çš„åŠŸèƒ½"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">App è·¯ç”±</label>
          <input type="text" class="form-input" id="groupRoute" placeholder="å¦‚ï¼š/home">
        </div>
        <div class="form-group">
          <label class="form-label">æºç è·¯å¾„</label>
          <input type="text" class="form-input" id="groupSourcePath" placeholder="å¦‚ï¼šlib/pages/home_page.dart">
        </div>
        <div class="form-group">
          <label class="form-label">æ ‡è®°é¢œè‰²</label>
          <div class="color-picker-row" id="groupColorPicker"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeGroupModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="confirmGroup()">åˆ›å»º</button>
      </div>
    </div>
  </div>

  <!-- Prompt Generator Modal -->
  <div class="modal-overlay" id="promptModal">
    <div class="modal wide">
      <div class="modal-header">
        <span class="modal-title">ç”Ÿæˆ AI æç¤ºè¯</span>
        <button class="modal-close" onclick="closePromptModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ç›®æ ‡å¹³å°</label>
          <select class="form-select" id="targetPlatform">
            <option value="flutter">Flutter (Dart)</option>
            <option value="react-native">React Native (TypeScript)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label" style="display:flex; align-items:center; gap:10px; cursor:pointer;">
            <input type="checkbox" id="includeDesignSystem" style="width:18px;height:18px;accent-color:var(--primary);">
            åŒ…å«è®¾è®¡ç³»ç»Ÿï¼ˆé¢œè‰²ã€å­—ä½“ã€é—´è·å®šä¹‰ï¼‰
          </label>
        </div>
        <div class="form-group">
          <label class="form-label">å›¾ç‰‡èµ„æºç›®å½•</label>
          <div style="display:flex;gap:10px;">
            <input type="text" class="form-input" id="assetsDir" value="assets/images" style="flex:1;">
            <button class="btn btn-secondary" onclick="extractAndCopyImages()">
              <span>ğŸ“¦</span> æå–å›¾ç‰‡
            </button>
          </div>
          <div id="imageStatus" style="font-size:12px;color:var(--text-muted);margin-top:8px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">ç”Ÿæˆçš„æç¤ºè¯</label>
          <pre class="prompt-preview" id="promptPreview">ç‚¹å‡»"ç”Ÿæˆ"æŒ‰é’®ç”Ÿæˆæç¤ºè¯</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="generatePrompt()">
          <span>ğŸ”„</span> ç”Ÿæˆ
        </button>
        <button class="btn btn-primary" onclick="copyPrompt()">
          <span>ğŸ“‹</span> å¤åˆ¶
        </button>
        <button class="btn btn-primary" onclick="downloadPrompt()">
          <span>ğŸ’¾</span> ä¸‹è½½
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">æ“ä½œæˆåŠŸ</div>

  <script>
    // ==================== çŠ¶æ€ç®¡ç† ====================
    let config = { currentProject: '', projects: [] };
    let pagesConfig = { projectName: '', pageGroups: [], htmlFiles: [] };
    let htmlFiles = [];
    let currentFile = null;
    let selectedFiles = new Set();
    let isPickerActive = false;
    let editingGroupId = null;
    let projectBrowsePath = '';

    const groupColors = [
      '#6366f1', '#8b5cf6', '#ec4899', '#ef4444',
      '#f59e0b', '#22c55e', '#14b8a6', '#3b82f6'
    ];

    // ==================== åˆå§‹åŒ– ====================
    async function init() {
      await loadConfig();
      await loadPages();
      await scanHtmlFiles();
      initWebSocket();
      initEventListeners();
      console.log('åˆå§‹åŒ–å®Œæˆ, pagesConfig:', pagesConfig);
    }

    async function loadConfig() {
      const res = await fetch('/api/config');
      config = await res.json();
      updateProjectDisplay();
    }

    async function loadPages() {
      const res = await fetch('/api/pages');
      const data = await res.json();
      // ç¡®ä¿ä¿ç•™æ‰€æœ‰å­—æ®µ
      pagesConfig = {
        projectName: data.projectName || 'My App',
        targetPlatform: data.targetPlatform || ['flutter'],
        designSystem: data.designSystem || {},
        sharedComponents: data.sharedComponents || [],
        htmlFiles: data.htmlFiles || [],
        pageGroups: data.pageGroups || []
      };
      console.log('loadPages å®Œæˆ, pageGroups:', pagesConfig.pageGroups);
    }

    function updateProjectDisplay() {
      const display = document.getElementById('projectPathDisplay');
      if (config.currentProject) {
        const project = config.projects.find(p => p.path === config.currentProject);
        display.textContent = project?.name || config.currentProject.split('/').pop();
      } else {
        display.textContent = 'æœªé€‰æ‹©';
      }
    }

    async function saveConfig() {
      await fetch('/api/pages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pagesConfig)
      });
      showToast('é…ç½®å·²ä¿å­˜');
    }

    function updatePathDisplays() {
      document.getElementById('projectPathDisplay').textContent =
        config.projectPath ? config.projectPath.split('/').pop() || config.projectPath : 'æœªè®¾ç½®';
      document.getElementById('htmlPathDisplay').textContent =
        config.htmlPath ? config.htmlPath.split('/').pop() || config.htmlPath : './html';
    }

    // ==================== HTMLæ–‡ä»¶ç®¡ç† ====================
    async function scanHtmlFiles() {
      const res = await fetch('/api/scan-html');
      const data = await res.json();
      htmlFiles = data.files;

      // åŒæ­¥åˆ°pagesConfig
      syncFilesToConfig();
      renderFileList();
    }

    function syncFilesToConfig() {
      // ä¿ç•™å·²æœ‰çš„ htmlFiles é…ç½®ï¼ˆåŒ…æ‹¬ groupId ç­‰ï¼‰
      const existingFilesMap = new Map(
        (pagesConfig.htmlFiles || []).map(f => [f.path, f])
      );

      // åŸºäºæ‰«æåˆ°çš„æ–‡ä»¶åˆ—è¡¨æ›´æ–°ï¼Œä½†ä¿ç•™å·²æœ‰é…ç½®
      const updatedFiles = [];
      for (const file of htmlFiles) {
        const existing = existingFilesMap.get(file.path);
        if (existing) {
          // ä¿ç•™å·²æœ‰é…ç½®ï¼ˆåŒ…æ‹¬ groupIdã€stateNameã€descriptionã€interactionsï¼‰
          updatedFiles.push(existing);
        } else {
          // åªä¸ºæ–°æ–‡ä»¶åˆ›å»ºé»˜è®¤é…ç½®
          updatedFiles.push({
            path: file.path,
            name: file.name,
            stateName: '',
            description: '',
            groupId: null,
            interactions: []
          });
        }
      }

      // åªæ›´æ–° htmlFilesï¼Œä¿ç•™å…¶ä»–é…ç½®ï¼ˆpageGroups ç­‰ï¼‰
      pagesConfig.htmlFiles = updatedFiles;

      console.log('syncFilesToConfig å®Œæˆ, htmlFiles:', pagesConfig.htmlFiles.length, 'pageGroups:', pagesConfig.pageGroups?.length);
    }

    function renderFileList() {
      const container = document.getElementById('fileList');
      const groups = pagesConfig.pageGroups || [];
      const files = pagesConfig.htmlFiles || [];

      let html = '';

      // æ¸²æŸ“åˆ†ç»„
      for (const group of groups) {
        const groupFiles = files.filter(f => f.groupId === group.id);
        html += `
          <div class="file-group" data-group-id="${group.id}">
            <div class="file-group-header" style="border-left-color: ${group.color || '#6366f1'}">
              <div class="group-color" style="background: ${group.color || '#6366f1'}"></div>
              <span class="group-name">${group.name}</span>
              <span class="group-count">${groupFiles.length}</span>
              <div class="group-actions">
                <button class="btn btn-icon btn-sm" onclick="event.stopPropagation(); editGroup('${group.id}')">âœï¸</button>
                <button class="btn btn-icon btn-sm" onclick="event.stopPropagation(); deleteGroup('${group.id}')">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="group-files">
              ${groupFiles.map(f => renderFileItem(f, group.color)).join('')}
            </div>
          </div>
        `;
      }

      // æ¸²æŸ“æœªåˆ†ç»„æ–‡ä»¶
      const ungroupedFiles = files.filter(f => !f.groupId);
      if (ungroupedFiles.length > 0) {
        html += `
          <div class="ungrouped-section">
            <div class="ungrouped-title">æœªåˆ†ç»„</div>
            ${ungroupedFiles.map(f => renderFileItem(f)).join('')}
          </div>
        `;
      }

      if (files.length === 0) {
        html = `
          <div style="padding: 60px 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.4;">ğŸ“‚</div>
            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">æš‚æ—  HTML æ–‡ä»¶</p>
            <p style="font-size: 12px; color: var(--text-muted);">è¯·è®¾ç½® HTML è·¯å¾„</p>
          </div>
        `;
      }

      container.innerHTML = html;
      updateGroupSelect();
    }

    function renderFileItem(file, groupColor) {
      const isActive = currentFile && currentFile.path === file.path;
      const isSelected = selectedFiles.has(file.path);

      return `
        <div class="file-item ${isActive ? 'active' : ''} ${isSelected ? 'selected' : ''}"
             data-path="${file.path}"
             onclick="selectFile('${file.path}')"
             ${groupColor ? `style="border-left-color: ${isActive ? 'white' : groupColor}"` : ''}>
          <span class="file-icon">ğŸ“„</span>
          <div class="file-info">
            <div class="file-name">${file.stateName || file.name}</div>
            <div class="file-path">${file.path}</div>
          </div>
          ${file.stateName ? `<span class="file-state-tag">${file.stateName}</span>` : ''}
        </div>
      `;
    }

    function selectFile(path, multiSelect = false) {
      if (multiSelect || event?.shiftKey || event?.metaKey) {
        if (selectedFiles.has(path)) {
          selectedFiles.delete(path);
        } else {
          selectedFiles.add(path);
        }
        updateSelectionToolbar();
        renderFileList();
        return;
      }

      selectedFiles.clear();
      updateSelectionToolbar();

      const file = pagesConfig.htmlFiles.find(f => f.path === path);
      if (file) {
        currentFile = file;
        previewHtml(path);
        loadFileToPanel();
        renderFileList();
      }
    }

    function updateSelectionToolbar() {
      const toolbar = document.getElementById('selectionToolbar');
      const count = document.getElementById('selectionCount');
      count.textContent = selectedFiles.size;
      toolbar.classList.toggle('active', selectedFiles.size > 0);
    }

    function cancelSelection() {
      selectedFiles.clear();
      updateSelectionToolbar();
      renderFileList();
    }

    // ==================== é¢„è§ˆ ====================
    function previewHtml(path) {
      const screen = document.getElementById('phoneScreen');
      screen.innerHTML = `<iframe id="previewFrame" src="/html/${path}"></iframe>`;
      document.getElementById('previewInfo').textContent = path;

      // è®¾ç½®å…ƒç´ é€‰æ‹©å™¨
      setTimeout(() => {
        const iframe = document.getElementById('previewFrame');
        if (iframe && iframe.contentWindow) {
          setupElementPicker(iframe);
        }
      }, 500);

      analyzeHtml(path);
    }

    async function analyzeHtml(path) {
      try {
        const res = await fetch(`/api/analyze-html?path=${encodeURIComponent(path)}`);
        const data = await res.json();
        renderAnalysis(data);
      } catch (e) {
        console.error('åˆ†æå¤±è´¥', e);
      }
    }

    function renderAnalysis(data) {
      // Structure tags
      const structureTags = document.getElementById('structureTags');
      const structures = [];
      if (data.structure.hasHeader) structures.push('Header');
      if (data.structure.hasFooter) structures.push('Footer/TabBar');
      if (data.structure.hasList) structures.push('åˆ—è¡¨');
      if (data.structure.hasForm) structures.push('è¡¨å•');
      if (data.structure.hasModal) structures.push('å¼¹çª—');
      if (data.structure.hasCard) structures.push('å¡ç‰‡');
      structureTags.innerHTML = structures.map(s => `<span class="tag active">${s}</span>`).join('') || '<span style="color:var(--text-muted);font-size:12px;">æ— ç‰¹æ®Šç»“æ„</span>';

      // Colors
      const colorGrid = document.getElementById('colorGrid');
      colorGrid.innerHTML = data.colors.slice(0, 16).map(c =>
        `<div class="color-chip" style="background:${c}" data-color="${c}" onclick="copyToClipboard('${c}')"></div>`
      ).join('') || '<span style="color:var(--text-muted);font-size:12px;">æœªæå–åˆ°é¢œè‰²</span>';

      // Interactive elements
      const interactiveElements = document.getElementById('interactiveElements');
      interactiveElements.innerHTML = data.interactiveElements.slice(0, 10).map(el => `
        <div class="tag clickable" style="margin-bottom:6px; display:block; padding:10px 12px;" onclick="addInteractionFromElement('${el.selector}', '${el.type}')">
          <strong style="color:var(--primary);">${el.type}</strong>
          <span style="color:var(--text-secondary);margin-left:6px;">${el.text || el.selector}</span>
        </div>
      `).join('') || '<span style="color:var(--text-muted);font-size:12px;">æœªå‘ç°å¯äº¤äº’å…ƒç´ </span>';
    }

    // ==================== å…ƒç´ é€‰æ‹©å™¨ ====================
    function togglePicker() {
      isPickerActive = !isPickerActive;
      const btn = document.getElementById('pickerBtn');
      btn.classList.toggle('active', isPickerActive);
      btn.textContent = isPickerActive ? 'ğŸ¯ ç‚¹å‡»é€‰æ‹©' : 'ğŸ¯ é€‰æ‹©å…ƒç´ ';

      const iframe = document.getElementById('previewFrame');
      if (iframe && iframe.contentWindow) {
        if (isPickerActive) {
          enablePicker(iframe);
        } else {
          disablePicker(iframe);
        }
      }
    }

    function setupElementPicker(iframe) {
      const doc = iframe.contentDocument;
      if (!doc) return;

      // æ³¨å…¥æ ·å¼
      const style = doc.createElement('style');
      style.id = 'picker-style';
      style.textContent = `
        .picker-hover { outline: 2px solid #6366f1 !important; outline-offset: 2px; cursor: crosshair !important; }
        .picker-selected { outline: 2px solid #22c55e !important; outline-offset: 2px; }
      `;
      doc.head.appendChild(style);
    }

    function enablePicker(iframe) {
      const doc = iframe.contentDocument;
      if (!doc) return;

      doc.body.style.cursor = 'crosshair';

      doc.addEventListener('mouseover', pickerMouseOver);
      doc.addEventListener('mouseout', pickerMouseOut);
      doc.addEventListener('click', pickerClick);
    }

    function disablePicker(iframe) {
      const doc = iframe.contentDocument;
      if (!doc) return;

      doc.body.style.cursor = '';
      doc.querySelectorAll('.picker-hover').forEach(el => el.classList.remove('picker-hover'));

      doc.removeEventListener('mouseover', pickerMouseOver);
      doc.removeEventListener('mouseout', pickerMouseOut);
      doc.removeEventListener('click', pickerClick);
    }

    function pickerMouseOver(e) {
      e.target.classList.add('picker-hover');
    }

    function pickerMouseOut(e) {
      e.target.classList.remove('picker-hover');
    }

    function pickerClick(e) {
      e.preventDefault();
      e.stopPropagation();

      const el = e.target;
      const selector = generateSelectorFromElement(el);

      // æ·»åŠ äº¤äº’
      addInteractionFromElement(selector, guessElementType(el));

      // å…³é—­é€‰æ‹©å™¨
      togglePicker();
    }

    function generateSelectorFromElement(el) {
      if (el.id) return `#${el.id}`;
      if (el.className) {
        const classes = el.className.split(' ').filter(Boolean).slice(0, 2);
        if (classes.length) return `.${classes.join('.')}`;
      }
      return el.tagName.toLowerCase();
    }

    function guessElementType(el) {
      const tag = el.tagName.toLowerCase();
      const cls = (el.className || '').toLowerCase();

      if (tag === 'button' || cls.includes('btn')) return 'tap';
      if (tag === 'a' || cls.includes('link')) return 'tap';
      if (tag === 'input' || tag === 'textarea') return 'input';
      if (cls.includes('tab')) return 'tap';
      return 'tap';
    }

    // ==================== æ–‡ä»¶é…ç½®é¢æ¿ ====================
    function loadFileToPanel() {
      if (!currentFile) return;

      document.getElementById('fileStateName').value = currentFile.stateName || '';
      document.getElementById('fileDescription').value = currentFile.description || '';
      document.getElementById('fileGroup').value = currentFile.groupId || '';

      renderInteractionList();
    }

    function updateCurrentFile() {
      if (!currentFile) return;

      currentFile.stateName = document.getElementById('fileStateName').value;
      currentFile.description = document.getElementById('fileDescription').value;
      currentFile.groupId = document.getElementById('fileGroup').value || null;

      renderFileList();
    }

    function renderInteractionList() {
      const container = document.getElementById('interactionList');
      if (!currentFile || !currentFile.interactions) {
        container.innerHTML = '<div style="color:var(--text-muted);font-size:12px;text-align:center;padding:24px;background:var(--bg);border-radius:var(--radius-md);border:1px dashed var(--border);">æš‚æ— äº¤äº’é…ç½®</div>';
        return;
      }

      container.innerHTML = currentFile.interactions.map((item, i) => `
        <div class="interaction-item">
          <div class="interaction-header">
            <span class="interaction-selector">${item.selector}</span>
            <span class="interaction-type">${item.eventType}</span>
            <button class="delete-btn" onclick="removeInteraction(${i})">âœ•</button>
          </div>
          <input class="form-input" value="${item.action}" placeholder="åŠ¨ä½œæè¿°"
                 onchange="updateInteraction(${i}, 'action', this.value)" style="margin-top:8px;">
        </div>
      `).join('');
    }

    function addInteraction() {
      if (!currentFile) {
        showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      if (!currentFile.interactions) currentFile.interactions = [];
      currentFile.interactions.push({
        selector: '',
        eventType: 'tap',
        action: ''
      });

      renderInteractionList();
    }

    function addInteractionFromElement(selector, eventType) {
      if (!currentFile) {
        showToast('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }

      if (!currentFile.interactions) currentFile.interactions = [];
      currentFile.interactions.push({
        selector: selector,
        eventType: eventType || 'tap',
        action: ''
      });

      renderInteractionList();
      showToast(`å·²æ·»åŠ : ${selector}`);
    }

    function updateInteraction(index, field, value) {
      if (!currentFile || !currentFile.interactions) return;
      currentFile.interactions[index][field] = value;
    }

    function removeInteraction(index) {
      if (!currentFile || !currentFile.interactions) return;
      currentFile.interactions.splice(index, 1);
      renderInteractionList();
    }

    // ==================== åˆ†ç»„ç®¡ç† ====================
    function updateGroupSelect() {
      const select = document.getElementById('fileGroup');
      const groups = pagesConfig.pageGroups || [];

      select.innerHTML = '<option value="">æœªåˆ†ç»„</option>' +
        groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');

      if (currentFile) {
        select.value = currentFile.groupId || '';
      }
    }

    function createGroup() {
      editingGroupId = null;
      document.getElementById('groupName').value = '';
      document.getElementById('groupDescription').value = '';
      document.getElementById('groupRoute').value = '';
      document.getElementById('groupSourcePath').value = '';

      // é¢œè‰²é€‰æ‹©å™¨
      const picker = document.getElementById('groupColorPicker');
      picker.innerHTML = groupColors.map((c, i) =>
        `<div class="color-option ${i === 0 ? 'selected' : ''}" style="background:${c}" data-color="${c}" onclick="selectGroupColor(this)"></div>`
      ).join('');

      document.getElementById('groupModal').classList.add('active');
    }

    function groupSelected() {
      if (selectedFiles.size === 0) return;
      createGroup();
    }

    function selectGroupColor(el) {
      document.querySelectorAll('#groupColorPicker .color-option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
    }

    function confirmGroup() {
      const name = document.getElementById('groupName').value.trim();
      if (!name) {
        showToast('è¯·è¾“å…¥åˆ†ç»„åç§°');
        return;
      }

      const selectedColor = document.querySelector('#groupColorPicker .color-option.selected');
      const color = selectedColor ? selectedColor.dataset.color : groupColors[0];

      if (!pagesConfig.pageGroups) pagesConfig.pageGroups = [];

      if (editingGroupId) {
        // ç¼–è¾‘ç°æœ‰åˆ†ç»„
        const group = pagesConfig.pageGroups.find(g => g.id === editingGroupId);
        if (group) {
          group.name = name;
          group.description = document.getElementById('groupDescription').value;
          group.route = document.getElementById('groupRoute').value;
          group.appSourcePath = document.getElementById('groupSourcePath').value;
          group.color = color;
        }
      } else {
        // åˆ›å»ºæ–°åˆ†ç»„
        const groupId = 'group_' + Date.now();
        pagesConfig.pageGroups.push({
          id: groupId,
          name: name,
          description: document.getElementById('groupDescription').value,
          route: document.getElementById('groupRoute').value,
          appSourcePath: document.getElementById('groupSourcePath').value,
          color: color
        });

        // å°†é€‰ä¸­çš„æ–‡ä»¶æ·»åŠ åˆ°åˆ†ç»„
        if (selectedFiles.size > 0) {
          for (const path of selectedFiles) {
            const file = pagesConfig.htmlFiles.find(f => f.path === path);
            if (file) file.groupId = groupId;
          }
          selectedFiles.clear();
          updateSelectionToolbar();
        }
      }

      closeGroupModal();
      renderFileList();
      showToast(editingGroupId ? 'åˆ†ç»„å·²æ›´æ–°' : 'åˆ†ç»„åˆ›å»ºæˆåŠŸ');
    }

    function editGroup(groupId) {
      const group = pagesConfig.pageGroups.find(g => g.id === groupId);
      if (!group) return;

      editingGroupId = groupId;
      document.getElementById('groupName').value = group.name;
      document.getElementById('groupDescription').value = group.description || '';
      document.getElementById('groupRoute').value = group.route || '';
      document.getElementById('groupSourcePath').value = group.appSourcePath || '';

      // é¢œè‰²é€‰æ‹©å™¨
      const picker = document.getElementById('groupColorPicker');
      picker.innerHTML = groupColors.map(c =>
        `<div class="color-option ${c === group.color ? 'selected' : ''}" style="background:${c}" data-color="${c}" onclick="selectGroupColor(this)"></div>`
      ).join('');

      document.getElementById('groupModal').classList.add('active');
    }

    function deleteGroup(groupId) {
      if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç»„ï¼Ÿæ–‡ä»¶å°†å˜ä¸ºæœªåˆ†ç»„çŠ¶æ€ã€‚')) return;

      pagesConfig.pageGroups = pagesConfig.pageGroups.filter(g => g.id !== groupId);

      // ç§»é™¤æ–‡ä»¶çš„åˆ†ç»„å…³è”
      for (const file of pagesConfig.htmlFiles) {
        if (file.groupId === groupId) file.groupId = null;
      }

      renderFileList();
      showToast('åˆ†ç»„å·²åˆ é™¤');
    }

    function closeGroupModal() {
      document.getElementById('groupModal').classList.remove('active');
      editingGroupId = null;
    }

    // ==================== é¡¹ç›®é€‰æ‹©å™¨ ====================
    function showProjectSelector() {
      renderRecentProjects();
      document.getElementById('newProjectPath').value = '';
      document.getElementById('projectBrowser').style.display = 'none';
      document.getElementById('projectModal').classList.add('active');
    }

    function closeProjectModal() {
      document.getElementById('projectModal').classList.remove('active');
    }

    function renderRecentProjects() {
      const container = document.getElementById('recentProjects');
      const projects = config.projects || [];

      if (projects.length === 0) {
        container.innerHTML = '<div style="padding:32px;text-align:center;color:var(--text-muted);font-size:13px;">æš‚æ— æœ€è¿‘é¡¹ç›®</div>';
        return;
      }

      container.innerHTML = projects.map(p => `
        <div class="browser-item ${p.path === config.currentProject ? 'selected' : ''}"
             onclick="switchToProject('${p.path}')" style="position:relative;">
          <span class="browser-icon">ğŸ“</span>
          <div style="flex:1;min-width:0;">
            <div class="browser-name">${p.name}</div>
            <div style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-top:2px;">${p.path}</div>
          </div>
          <button class="delete-btn" onclick="event.stopPropagation(); removeProject('${p.path}')" title="ç§»é™¤">âœ•</button>
        </div>
      `).join('');
    }

    async function switchToProject(projectPath) {
      try {
        const res = await fetch('/api/switch-project', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectPath })
        });
        const data = await res.json();
        if (data.success) {
          config = data.config;
          updateProjectDisplay();
          closeProjectModal();
          await loadPages();
          await scanHtmlFiles();
          showToast('å·²åˆ‡æ¢é¡¹ç›®');
        }
      } catch (e) {
        showToast('åˆ‡æ¢å¤±è´¥');
      }
    }

    async function removeProject(projectPath) {
      if (!confirm('ç¡®å®šä»åˆ—è¡¨ä¸­ç§»é™¤æ­¤é¡¹ç›®ï¼Ÿ')) return;

      try {
        const res = await fetch('/api/remove-project', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ projectPath })
        });
        const data = await res.json();
        if (data.success) {
          config = data.config;
          updateProjectDisplay();
          renderRecentProjects();
          if (config.currentProject !== projectPath) {
            // å¦‚æœç§»é™¤çš„ä¸æ˜¯å½“å‰é¡¹ç›®ï¼Œæ— éœ€é‡æ–°åŠ è½½
          } else {
            await loadPages();
            await scanHtmlFiles();
          }
        }
      } catch (e) {
        showToast('ç§»é™¤å¤±è´¥');
      }
    }

    function browseForProject() {
      projectBrowsePath = '/';
      document.getElementById('projectBrowser').style.display = 'block';
      browseProjectPath('/');
    }

    async function browseProjectPath(dirPath) {
      if (dirPath === '..') {
        const parts = projectBrowsePath.split('/').filter(Boolean);
        parts.pop();
        dirPath = '/' + parts.join('/');
      }
      projectBrowsePath = dirPath;
      document.getElementById('projectBrowserPath').value = dirPath;

      try {
        const res = await fetch(`/api/browse?path=${encodeURIComponent(dirPath)}`);
        const data = await res.json();

        const list = document.getElementById('projectBrowserList');
        let html = data.items.filter(i => i.isDirectory).map(item => `
          <div class="browser-item" ondblclick="browseProjectPath('${item.path}')" onclick="selectProjectPath('${item.path}')">
            <span class="browser-icon">ğŸ“</span>
            <span class="browser-name">${item.name}</span>
          </div>
        `).join('');

        list.innerHTML = html || '<div style="padding:20px;text-align:center;color:var(--text-secondary)">ç©ºç›®å½•</div>';
      } catch (e) {
        console.error('æµè§ˆå¤±è´¥', e);
      }
    }

    function selectProjectPath(path) {
      document.getElementById('newProjectPath').value = path;
      // é«˜äº®é€‰ä¸­é¡¹
      document.querySelectorAll('#projectBrowserList .browser-item').forEach(el => {
        el.classList.remove('selected');
        if (el.onclick.toString().includes(path)) {
          el.classList.add('selected');
        }
      });
    }

    async function addAndSwitchProject() {
      const projectPath = document.getElementById('newProjectPath').value.trim();
      if (!projectPath) {
        showToast('è¯·è¾“å…¥æˆ–é€‰æ‹©é¡¹ç›®è·¯å¾„');
        return;
      }
      await switchToProject(projectPath);
    }

    // ==================== æç¤ºè¯ç”Ÿæˆ ====================
    function showPromptModal() {
      document.getElementById('promptModal').classList.add('active');
      document.getElementById('imageStatus').textContent = '';
      generatePrompt();
    }

    function closePromptModal() {
      document.getElementById('promptModal').classList.remove('active');
    }

    async function generatePrompt() {
      const platform = document.getElementById('targetPlatform').value;
      const includeDesignSystem = document.getElementById('includeDesignSystem').checked;

      try {
        const res = await fetch('/api/generate-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pages: pagesConfig,
            targetPlatform: platform,
            includeDesignSystem: includeDesignSystem
          })
        });
        const data = await res.json();
        document.getElementById('promptPreview').textContent = data.prompt;
      } catch (e) {
        showToast('ç”Ÿæˆå¤±è´¥');
      }
    }

    // æå–å¹¶å¤åˆ¶å›¾ç‰‡åˆ°é¡¹ç›®assetsç›®å½•
    async function extractAndCopyImages() {
      if (!config.currentProject) {
        showToast('è¯·å…ˆé€‰æ‹©é¡¹ç›®');
        return;
      }

      const statusEl = document.getElementById('imageStatus');
      statusEl.textContent = 'æ­£åœ¨æå–å›¾ç‰‡...';

      const allImages = [];

      // ä»æ‰€æœ‰HTMLæ–‡ä»¶æå–å›¾ç‰‡
      for (const file of pagesConfig.htmlFiles || []) {
        try {
          const res = await fetch(`/api/extract-images?path=${encodeURIComponent(file.path)}`);
          const data = await res.json();
          allImages.push(...data.images);
        } catch (e) {
          console.error('æå–å¤±è´¥:', file.path, e);
        }
      }

      // å»é‡
      const uniqueImages = [...new Map(allImages.map(i => [i.src, i])).values()];

      if (uniqueImages.length === 0) {
        statusEl.textContent = 'æœªå‘ç°éœ€è¦æå–çš„å›¾ç‰‡';
        return;
      }

      statusEl.textContent = `å‘ç° ${uniqueImages.length} å¼ å›¾ç‰‡ï¼Œæ­£åœ¨å¤åˆ¶...`;

      // å¤åˆ¶åˆ°é¡¹ç›®ç›®å½•
      const targetDir = document.getElementById('assetsDir').value || 'assets/images';
      try {
        const res = await fetch('/api/copy-images', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ images: uniqueImages, targetDir })
        });
        const data = await res.json();

        if (data.copied.length > 0) {
          statusEl.innerHTML = `<span style="color:var(--success)">âœ“ å·²å¤åˆ¶ ${data.copied.length} å¼ å›¾ç‰‡åˆ° ${data.assetsDir}</span>`;
          if (data.failed.length > 0) {
            statusEl.innerHTML += `<br><span style="color:var(--warning)">âš  ${data.failed.length} å¼ å¤±è´¥</span>`;
          }
        } else {
          statusEl.innerHTML = `<span style="color:var(--warning)">âš  å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„</span>`;
        }
      } catch (e) {
        statusEl.innerHTML = `<span style="color:var(--error)">âœ• å¤åˆ¶å¤±è´¥: ${e.message}</span>`;
      }
    }

    function copyPrompt() {
      const text = document.getElementById('promptPreview').textContent;
      navigator.clipboard.writeText(text);
      showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }

    function downloadPrompt() {
      const text = document.getElementById('promptPreview').textContent;
      const blob = new Blob([text], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'pages-prompt.md';
      a.click();
      URL.revokeObjectURL(url);
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      showToast('å·²å¤åˆ¶: ' + text);
    }

    // ==================== WebSocket ====================
    function initWebSocket() {
      const ws = new WebSocket(`ws://${location.host}`);
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === 'reload') {
          scanHtmlFiles();
          if (currentFile) {
            previewHtml(currentFile.path);
          }
        }
      };
      ws.onclose = () => setTimeout(initWebSocket, 3000);
    }

    // ==================== äº‹ä»¶ç›‘å¬ ====================
    function initEventListeners() {
      // Panelåˆ‡æ¢
      document.querySelectorAll('.panel-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const panel = tab.dataset.panel;
          document.getElementById('filePanel').style.display = panel === 'file' ? 'block' : 'none';
          document.getElementById('analysisPanel').style.display = panel === 'analysis' ? 'block' : 'none';
        });
      });

      // è®¾å¤‡åˆ‡æ¢
      document.querySelectorAll('.device-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          const screen = document.querySelector('.phone-screen');
          screen.style.width = btn.dataset.width + 'px';
          screen.style.height = btn.dataset.height + 'px';
        });
      });

      // è¡¨å•è‡ªåŠ¨æ›´æ–°
      ['fileStateName', 'fileDescription', 'fileGroup'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateCurrentFile);
      });
    }

    // å¯åŠ¨
    init();
  </script>
</body>
</html>
