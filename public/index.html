<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Page Studio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <!-- Web Component 必须在使用前加载 -->
  <script src="/js/icons.js"></script>
  <!-- 主题必须在 body 渲染前加载，防止闪烁 -->
  <script src="/js/theme.js"></script>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="logo">
        <div class="logo-icon">
          <icon-component name="smartphone" size="md"></icon-component>
        </div>
        <span>App Page Studio</span>
      </div>

      <div class="path-display" onclick="showProjectSelector()">
        <span class="path-label">项目</span>
        <span class="path-value" id="projectPathDisplay">未选择</span>
        <span class="path-chevron">
          <icon-component name="chevronDown" size="sm"></icon-component>
        </span>
      </div>

      <button class="btn btn-icon btn-secondary" id="designSystemBtn" onclick="openCurrentProjectDesignSystem()" title="设计系统配置">
        <icon-component name="palette" size="md"></icon-component>
      </button>

      <div class="header-actions">
        <button class="btn btn-icon btn-secondary" id="themeToggle" onclick="toggleTheme()" title="切换主题">
          <span id="themeIcon">
            <icon-component name="moon" size="md"></icon-component>
          </span>
        </button>
        <button class="btn btn-secondary" onclick="scanHtmlFiles()">
          <icon-component name="refresh"></icon-component>
          刷新
        </button>
        <button class="btn btn-secondary" onclick="saveConfig()">
          <icon-component name="save"></icon-component>
          保存
        </button>
        <button class="btn btn-secondary" onclick="downloadPagesConfig()">
          <icon-component name="download"></icon-component>
          下载配置
        </button>
        <button class="btn btn-primary" onclick="showPromptModal()">
          <icon-component name="sparkles"></icon-component>
          生成提示词
        </button>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <span class="sidebar-title">HTML 文件</span>
        <button class="btn btn-sm btn-secondary" onclick="createGroup()">
          <icon-component name="plus" size="sm"></icon-component>
          新建页面分组
        </button>
      </div>

      <!-- Search and Filter -->
      <div class="sidebar-filter">
        <div class="search-box">
          <icon-component name="search" size="sm"></icon-component>
          <input type="text" id="fileSearchInput" placeholder="搜索文件名..." oninput="filterFileList()">
        </div>
        <div class="status-filter-bar">
          <button class="status-filter-btn active" data-status="all" onclick="setStatusFilter('all')">全部</button>
          <button class="status-filter-btn" data-status="pending" onclick="setStatusFilter('pending')">
            <span class="status-dot pending"></span>待开发
          </button>
          <button class="status-filter-btn" data-status="developing" onclick="setStatusFilter('developing')">
            <span class="status-dot developing"></span>开发中
          </button>
          <button class="status-filter-btn" data-status="completed" onclick="setStatusFilter('completed')">
            <span class="status-dot completed"></span>已完成
          </button>
        </div>
      </div>

      <!-- Selection toolbar -->
      <div class="selection-toolbar" id="selectionToolbar">
        <span>已选择 <span class="selection-count" id="selectionCount">0</span> 个文件</span>
        <button class="btn btn-sm" style="background:#000;color:#fff" onclick="groupSelected()">创建分组</button>
        <button class="btn btn-sm btn-secondary" onclick="cancelSelection()">取消</button>
      </div>

      <div class="sidebar-content" id="fileList">
        <!-- Dynamic content -->
      </div>
    </aside>

    <!-- Preview -->
    <main class="preview-container">
      <div class="preview-toolbar">
        <div class="device-selector">
          <button class="device-btn active" data-width="375" data-height="812">iPhone 14</button>
          <button class="device-btn" data-width="390" data-height="844">iPhone Pro</button>
          <button class="device-btn" data-width="360" data-height="780">Android</button>
        </div>
        <div class="preview-actions">
          <div class="zoom-control">
            <button class="zoom-btn" onclick="adjustZoom(-0.05)" title="缩小">
              <icon-component name="minus" size="sm"></icon-component>
            </button>
            <input type="range" id="zoomSlider" class="zoom-slider" min="0.25" max="1.5" step="0.01" value="1" onchange="setZoom(this.value)" oninput="setZoom(this.value)">
            <button class="zoom-btn" onclick="adjustZoom(0.05)" title="放大">
              <icon-component name="plus" size="sm"></icon-component>
            </button>
            <span class="zoom-value" id="zoomValue">100%</span>
            <button class="zoom-btn" onclick="resetZoom()" title="重置">
              <icon-component name="refresh" size="sm"></icon-component>
            </button>
          </div>
          <button class="color-picker-btn" id="colorPickerBtn" onclick="toggleColorPicker()">
            <icon-component name="pipette"></icon-component>
            <span id="colorPickerBtnText">取色</span>
          </button>
          <button class="picker-btn" id="pickerBtn" onclick="togglePicker()">
            <icon-component name="target"></icon-component>
            <span id="pickerBtnText">选择元素</span>
          </button>
          <span class="preview-info" id="previewInfo">未选择文件</span>
        </div>
      </div>
      <div class="preview-frame-wrapper">
        <div class="phone-frame">
          <div class="phone-screen" id="phoneScreen">
            <div class="empty-preview">
              <div class="empty-preview-icon">
                <icon-component name="fileEmpty" size="xl"></icon-component>
              </div>
              <p>选择 HTML 文件预览</p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Panel -->
    <aside class="panel">
      <div class="panel-tabs">
        <div class="panel-tab active" data-panel="file">文件配置</div>
        <!-- <div class="panel-tab" data-panel="analysis">智能分析</div> -->
      </div>

      <!-- File Config Panel -->
      <div class="panel-content" id="filePanel">
        <div class="panel-section">
          <div class="panel-section-title">基本信息</div>
          <div class="form-group">
            <label class="form-label">状态名称</label>
            <input type="text" class="form-input" id="fileStateName" placeholder="如：默认状态、加载中、空数据">
          </div>
          <div class="form-group">
            <label class="form-label">状态描述</label>
            <textarea class="form-textarea" id="fileDescription" placeholder="描述此状态的显示场景"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">开发状态</label>
            <div class="dev-status-radio-group" id="fileDevStatus">
              <label class="radio-label">
                <input type="radio" name="devStatus" value="pending">
                <span class="dev-status-badge pending">待开发</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="devStatus" value="developing">
                <span class="dev-status-badge developing">开发中</span>
              </label>
              <label class="radio-label">
                <input type="radio" name="devStatus" value="completed">
                <span class="dev-status-badge completed">已完成</span>
              </label>
            </div>
          </div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">所属页面分组</div>
          <select class="form-select" id="fileGroup">
            <option value="">未分组</option>
          </select>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">交互行为</div>
          <div id="interactionList"></div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">图片替换</div>
          <div id="imageReplacementList"></div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">功能描述</div>
          <div id="functionDescriptionList"></div>
        </div>
      </div>

      <!-- Analysis Panel -->
      <div class="panel-content" id="analysisPanel" style="display:none;">
        <div class="panel-section">
          <div class="panel-section-title">页面结构</div>
          <div class="tag-list" id="structureTags"></div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">提取的颜色</div>
          <div class="color-grid" id="colorGrid"></div>
        </div>

        <div class="panel-section">
          <div class="panel-section-title">可交互元素</div>
          <div id="interactiveElements"></div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Project Selector Modal -->
  <div class="modal-overlay" id="projectModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">项目管理</span>
        <button class="modal-close" onclick="closeProjectModal()">
          <icon-component name="x"></icon-component>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">项目列表</label>
          <div id="projectList" class="browser-list" style="max-height:280px;margin-bottom:16px;"></div>
        </div>
        <div class="form-group" style="border-top:1px solid var(--border);padding-top:16px;">
          <label class="form-label" id="projectFormTitle">创建新项目</label>
          <input type="text" class="form-input" id="newProjectName" placeholder="项目名称" style="margin-bottom:8px;">
          <textarea class="form-textarea" id="newProjectDescription" placeholder="项目描述（可选）" style="margin-bottom:8px;min-height:60px;"></textarea>
          <div class="form-group">
            <label class="form-label">设计系统（JSON 格式，可选）</label>
            <textarea class="form-textarea" id="newProjectDesignSystem" placeholder='{"colors": {"primary": "#6366f1"}, "spacing": {"sm": 8}}' style="min-height:80px;font-family:'JetBrains Mono',monospace;font-size:12px;"></textarea>
          </div>
          <div class="file-upload-wrapper">
            <input type="file" id="newProjectZip" accept=".zip" style="display:none;" onchange="handleZipSelect(this)">
            <button class="btn btn-secondary" style="width:100%;" onclick="document.getElementById('newProjectZip').click()">
              <icon-component name="upload"></icon-component>
              选择 HTML ZIP 文件
            </button>
            <div id="zipFileName" style="font-size:12px;color:var(--text-muted);margin-top:6px;text-align:center;">未选择文件</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProjectModal()">关闭</button>
        <button class="btn btn-primary" id="projectSubmitBtn" onclick="createOrUpdateProject()">创建</button>
      </div>
    </div>
  </div>

  <!-- Create Group Modal -->
  <div class="modal-overlay" id="groupModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">创建页面分组</span>
        <button class="modal-close" onclick="closeGroupModal()">
          <icon-component name="x"></icon-component>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">分组名称</label>
          <input type="text" class="form-input" id="groupName" placeholder="如：首页、登录页">
        </div>
        <div class="form-group">
          <label class="form-label">页面描述</label>
          <textarea class="form-textarea" id="groupDescription" placeholder="描述此页面的功能"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">App 路由</label>
          <input type="text" class="form-input" id="groupRoute" placeholder="如：/home">
        </div>
        <div class="form-group">
          <label class="form-label">源码路径</label>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:12px;color:var(--text-muted);width:80px;">Flutter</span>
              <input type="text" class="form-input" id="groupSourcePathFlutter" placeholder="如：lib/pages/home_page.dart" style="flex:1;">
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:12px;color:var(--text-muted);width:80px;">React Native</span>
              <input type="text" class="form-input" id="groupSourcePathRN" placeholder="如：app/home.tsx" style="flex:1;">
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span style="font-size:12px;color:var(--text-muted);width:80px;">UniApp</span>
              <input type="text" class="form-input" id="groupSourcePathUniapp" placeholder="如：pages/home/home.vue" style="flex:1;">
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">标记颜色</label>
          <div class="color-picker-row" id="groupColorPicker"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeGroupModal()">取消</button>
        <button class="btn btn-primary" onclick="confirmGroup()">创建</button>
      </div>
    </div>
  </div>

  <!-- Prompt Generator Modal -->
  <div class="modal-overlay" id="promptModal">
    <div class="modal wide">
      <div class="modal-header">
        <span class="modal-title">生成 AI 提示词</span>
        <button class="modal-close" onclick="closePromptModal()">
          <icon-component name="x"></icon-component>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">目标平台</label>
          <select class="form-select" id="targetPlatform">
            <option value="flutter">Flutter (Dart)</option>
            <option value="react-native">React Native (TypeScript)</option>
            <option value="uniapp">UniApp (Vue)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">筛选页面</label>
          <div class="dev-status-filter">
            <label class="checkbox-label">
              <input type="checkbox" id="filterPending" value="pending">
              <span class="dev-status-badge pending">待开发</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="filterDeveloping" value="developing" checked>
              <span class="dev-status-badge developing">开发中</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="filterCompleted" value="completed">
              <span class="dev-status-badge completed">已完成</span>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">生成的提示词</label>
          <pre class="prompt-preview" id="promptPreview">点击"生成"按钮生成提示词</pre>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="generatePrompt()">
          <icon-component name="refresh"></icon-component>
          生成
        </button>
        <button class="btn btn-primary" onclick="copyPrompt()">
          <icon-component name="copy"></icon-component>
          复制
        </button>
        <button class="btn btn-primary" onclick="downloadPrompt()">
          <icon-component name="download"></icon-component>
          下载
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">操作成功</div>

  <!-- Design System Drawer -->
  <div class="drawer-overlay" id="designSystemDrawer" onclick="closeDesignSystemDrawer(event)">
    <div class="drawer" onclick="event.stopPropagation()">
      <div class="drawer-header">
        <span class="drawer-title">
          <icon-component name="palette" size="md"></icon-component>
          设计系统配置
        </span>
        <button class="modal-close" onclick="closeDesignSystemDrawer()">
          <icon-component name="x"></icon-component>
        </button>
      </div>
      <div class="drawer-body">
        <!-- 项目信息 -->
        <div class="design-section">
          <div class="design-section-header">
            <span class="design-section-title">
              <icon-component name="folder" size="sm"></icon-component>
              项目
            </span>
          </div>
          <div id="designProjectName" style="font-size:14px;font-weight:500;margin-bottom:8px;">-</div>
        </div>

        <!-- 颜色配置 -->
        <div class="design-section">
          <div class="design-section-header">
            <span class="design-section-title">
              <icon-component name="palette" size="sm"></icon-component>
              颜色
            </span>
            <button class="btn btn-sm btn-secondary" onclick="addDesignColor()">
              <icon-component name="plus" size="sm"></icon-component>
              添加
            </button>
          </div>
          <div id="designColorsGrid" class="design-colors-grid">
            <!-- 动态渲染 -->
          </div>
        </div>

        <!-- 取色结果（如果有） -->
        <div class="design-section" id="pickedColorsSection" style="display:none;">
          <div class="design-section-header">
            <span class="design-section-title">
              <icon-component name="pipette" size="sm"></icon-component>
              已取颜色
            </span>
            <button class="btn btn-sm btn-secondary" onclick="clearPickedColors()">清空</button>
          </div>
          <div id="pickedColorsGrid" class="picked-colors-grid">
            <!-- 动态渲染 -->
          </div>
          <div style="margin-top:12px;">
            <button class="btn btn-sm btn-primary" onclick="addPickedColorsToDesign()" style="width:100%;">
              <icon-component name="plus" size="sm"></icon-component>
              添加到设计系统
            </button>
          </div>
        </div>

        <!-- 间距配置 -->
        <div class="design-section">
          <div class="design-section-header">
            <span class="design-section-title">
              <icon-component name="package" size="sm"></icon-component>
              间距
            </span>
          </div>
          <div class="form-group" style="margin-bottom:8px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label class="form-label">xs</label>
                <input type="number" class="form-input" id="spacingXs" placeholder="4" onchange="updateDesignSpacing()">
              </div>
              <div>
                <label class="form-label">sm</label>
                <input type="number" class="form-input" id="spacingSm" placeholder="8" onchange="updateDesignSpacing()">
              </div>
              <div>
                <label class="form-label">md</label>
                <input type="number" class="form-input" id="spacingMd" placeholder="16" onchange="updateDesignSpacing()">
              </div>
              <div>
                <label class="form-label">lg</label>
                <input type="number" class="form-input" id="spacingLg" placeholder="24" onchange="updateDesignSpacing()">
              </div>
              <div>
                <label class="form-label">xl</label>
                <input type="number" class="form-input" id="spacingXl" placeholder="32" onchange="updateDesignSpacing()">
              </div>
            </div>
          </div>
        </div>

        <!-- 圆角配置 -->
        <div class="design-section">
          <div class="design-section-header">
            <span class="design-section-title">
              <icon-component name="package" size="sm"></icon-component>
              圆角
            </span>
          </div>
          <div class="form-group" style="margin-bottom:8px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <label class="form-label">sm</label>
                <input type="number" class="form-input" id="radiusSm" placeholder="4" onchange="updateDesignRadius()">
              </div>
              <div>
                <label class="form-label">md</label>
                <input type="number" class="form-input" id="radiusMd" placeholder="8" onchange="updateDesignRadius()">
              </div>
              <div>
                <label class="form-label">lg</label>
                <input type="number" class="form-input" id="radiusLg" placeholder="12" onchange="updateDesignRadius()">
              </div>
              <div>
                <label class="form-label">xl</label>
                <input type="number" class="form-input" id="radiusXl" placeholder="16" onchange="updateDesignRadius()">
              </div>
            </div>
          </div>
        </div>

        <!-- 原始 JSON -->
        <div class="design-section">
          <div class="design-section-header">
            <span class="design-section-title">
              <icon-component name="file" size="sm"></icon-component>
              原始 JSON
            </span>
          </div>
          <textarea class="form-textarea" id="designSystemJson" style="min-height:120px;font-family:'JetBrains Mono',monospace;font-size:11px;" placeholder='{"colors": {}, "spacing": {}}'></textarea>
          <button class="btn btn-sm btn-secondary" onclick="parseDesignSystemJson()" style="margin-top:8px;">解析 JSON</button>
        </div>
      </div>
      <div class="drawer-footer">
        <button class="btn btn-secondary" onclick="closeDesignSystemDrawer()">取消</button>
        <button class="btn btn-primary" onclick="saveDesignSystem()">
          <icon-component name="save" size="sm"></icon-component>
          保存
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript 模块 -->
  <script src="/js/state.js"></script>
  <script src="/js/api.js"></script>
  <script src="/js/picker.js"></script>
  <script src="/js/ui.js"></script>
  <script src="/js/app.js"></script>
</body>
</html>
